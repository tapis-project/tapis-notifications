package edu.utexas.tacc.tapis.notifications.service;

import edu.utexas.tacc.tapis.notifications.dao.NotificationsDao;
import edu.utexas.tacc.tapis.notifications.model.DeliveryMethod;
import edu.utexas.tacc.tapis.notifications.model.Event;
import edu.utexas.tacc.tapis.notifications.model.Notification;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import javax.inject.Inject;
import java.io.IOException;
import java.util.concurrent.Callable;

/*
 * Callable for sending out a single notification generated by a bucket manager.
 */
public final class DeliveryTask implements Callable<String>
{
  /* ********************************************************************** */
  /*                               Constants                                */
  /* ********************************************************************** */
  // Tracing.
  private static final Logger log = LoggerFactory.getLogger(DeliveryTask.class);

//  public static final String VHOST = "NotificationsHost";
//  public static final String DEFAULT_BINDING_KEY = "#";
//  public static final String EXCHANGE_MAIN = "tapis.notifications.exchange";
//  public static final String QUEUE_MAIN = "tapis.notifications.queue";

  /* ********************************************************************** */
  /*                                Enums                                   */
  /* ********************************************************************** */

  /* ********************************************************************** */
  /*                                 Fields                                 */
  /* ********************************************************************** */

  // Use HK2 to inject singletons
  @Inject
  private NotificationsDao dao;

  private final int bucketNum; // Bucket that generated the notification
  private final Notification notification; // The notification to be processed

  /* ********************************************************************** */
  /*                             Constructors                               */
  /* ********************************************************************** */

  DeliveryTask(Notification n1, int bucketNum1)
  {
    bucketNum = bucketNum1;
    notification = n1;
  }
  
  /* ********************************************************************** */
  /*                             Public Methods                             */
  /* ********************************************************************** */

  /*
   * Main method for thread.start
   */
  @Override
  public String call()
  {
//    log.info("**** Starting Delivery task: {}", workerId);
    log.info("**** Starting Delivery task");
    try {log.info("Sleep 2 seconds"); Thread.sleep(2000); } catch (InterruptedException e) {}

    try
    {
        processNotification(notification);
    }
    catch (IOException e)
    {
      // TODO
      log.warn("Caught exception: " + e.getMessage(), e);
    }

    return "Delivery task complete. deliveryMethod: " + notification.getDeliveryMethod();
  }

  /* ********************************************************************** */
  /*                             Accessors                                  */
  /* ********************************************************************** */

  public int getBucketNum() { return bucketNum; }

  /* ********************************************************************** */
  /*                             Private Methods                            */
  /* ********************************************************************** */

  private void processNotification(Notification notification) throws IOException
  {
    Event event = notification.getEvent();
    DeliveryMethod deliveryMethod = notification.getDeliveryMethod();
    log.info("Processing notification for event. Source: {} Type: {} Subject: {} SeriesId: {} Time: {} UUID {}",
             event.getSource(), event.getType(), event.getSubject(), event.getSeriesId(),
             event.getTime(), event.getUuid());
    log.info("TODO Deliver notification. DeliveryType: {} DeliveryAddress: {}", deliveryMethod.getDeliveryType(),
             deliveryMethod.getDeliveryAddress());
    try {log.info("Sleep 2 seconds"); Thread.sleep(2000); } catch (InterruptedException e) {};
  }
}